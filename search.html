<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="description" content="Silly Recipe App" />
		<meta name="keywords" content="walmart,hack,hackathon,2016,recipe,list" />
		<meta name="author" content="Michael Ripley" />
		<title>Silly Recipe App</title>
        <script type="text/javascript" src="util.js"></script>
    </head>
    <body>
        Search results:
        
        <div id="listContainer"></div>
        <div><ul id="cartContainer"></ul></div>
        
        <div id="results" style="visibility: hidden">
            <div id="totalPrice"></div>
            <div id="buy-button" class="walmart-buy-now" data-color="blue"></div> <!-- data-publisherid="{Publisher ID}" -->
        </div>
        
        <script type="text/javascript">
            // setup buynow button
            (function(d, s, id) {
                var js, fjs = d.getElementsByTagName(s)[0];
                if (d.getElementById(id)) return;
                js = d.createElement(s); js.id = id;
                js.src = "https://affil.walmart.com/buttons/buynow.min.js";
                fjs.parentNode.insertBefore(js, fjs);
            }(document, 'script', 'walmart-buynow-js'));
        
        
            var queryParams = getGetParameters();
            console.log(queryParams);
            var listContainer = document.getElementById("listContainer");
            var cartContainer = document.getElementById("cartContainer");
            var resultContainer = document.getElementById("results");
            var priceContainer = document.getElementById("totalPrice");
            var totalPrice = 0;
            
            try {
                walmartBuyNow.clearAllItems("buy-button");
            } catch (e) {
                // i don't care
            }
            
            if (queryParams) {
                if (queryParams.listname && queryParams.items) {
                    var list = document.createElement("ul");
                
                    var newElement = document.createElement("h3");
                    var text = document.createTextNode(queryParams.listname);
                    newElement.appendChild(text);
                    listContainer.appendChild(newElement);
                
                    queryParams.items.forEach(function(item) {
                        newElement = document.createElement("li");
                        text = document.createTextNode(item);
                        newElement.appendChild(text);
                        list.appendChild(newElement);
                        
                        
                        lookupItem(item, function(req) {
                            if (req.readyState == 4 && req.status == 200) {
                                var response = JSON.parse(req.responseText);
                                
                                if (response.numItems == 1) {
                                    var item = response.items[0];
                                    var itemId = "" + item.itemId; // int
                                    var upc = item.upc; // string
                                    var name = item.name; // string
                                    var price = item.salePrice // number
                                    totalPrice += price;
                                    priceContainer.textContent = totalPrice;
                                    
                                    console.log(item);
                                    
                                    var newCartElement = document.createElement("li");
                                    var cartText = document.createTextNode(name + " ($" + price + ")");
                                    newCartElement.appendChild(cartText);
                                    cartContainer.appendChild(newCartElement);
                                    
                                    var itemObject = {id: itemId, type: "walmart_id", quantity: 1};
                                    console.log(itemObject);
                                    
                                    try {
                                        walmartBuyNow.addItem("buy-button", itemObject);
                                    } catch (e) {
                                        console.log(e);
                                    }
                                    
                                    console.log("Showing button");
                                    resultContainer.style.visibility = "visible";
                                    
                                } else {
                                    // handle no item
                                }
                            }
                        });
                    });
                    listContainer.appendChild(list);
                    
                } else {
                    console.log("queryparams was missing stuff");
                }
            } else {
                console.log("queryparams was falsey");
            }
            
            
        </script>
    </body>
</html>


